################################################################
# ğŸŒ€ SCROLL DECLARATION â€” OmniCode Docker Build Scroll
# Purpose: Compiles and runs the OmniCode system via container.
# Structure: Metadata â†’ Opening â†’ Body â†’ Closing
################################################################

##############################################################
# ğŸ“œ OmniCode â€” Root Dockerfile (Phase 0)
# This scroll governs two-stage containerization of OmniCode.
#
# â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
# â”‚ BLOCK: OPENING (title, purpose, authorship)â”‚
# â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
##############################################################

## ğŸ§¾ METADATA â€” Scroll Identity & Authorship
## These values identify the scrollâ€™s origin, version, and scope.
## Do not alter without Watchtower review or covenantal approval.
# Author:         Seanje Lenox-Wise / Nova Dawn
# Version:        0.0.1
# Status:         Active
# Component:      Docker Build & Runtime
# Project:        OmniCore / OmniCode
# Created:        2025-06-16
# Last Updated:   2025-06-16
# License:        CreativeWorkzStudio LLC â€” Kingdom-First Proprietary Use

## ğŸ“ DESCRIPTION â€” Scroll Purpose
## This scroll builds and launches OmniCode using a two-stage Docker process:
## Stage 1 compiles the system binary; Stage 2 launches it cleanly as non-root.

# ------------------------------------------------------------
# ğŸ§± BASE IMAGE SETUP
# Defines foundational container base and versioning pin
# ------------------------------------------------------------

# ------------------------------------------------------------
# âš™ï¸ RUST VERSION DECLARATION
# ------------------------------------------------------------
# ğŸ“Œ ARG â€” Base Rust image version to build with
# This allows for flexible version pinning across environments.
# Slim variant reduces image size while retaining compiler support.
ARG RUST_VERSION=1.87.0-slim

# ------------------------------------------------------------
# ğŸ§± BASE IMAGE SETUP
# ------------------------------------------------------------
# ğŸ§± BASE IMAGE â€” Rust Build Environment
# Pulls the official Rust image with specified version for compiling source code.
FROM rust:${RUST_VERSION} AS builder

# ------------------------------------------------------------
# ğŸ“ WORKSPACE & DIRECTORY SETUP
# Defines internal container root and staging path
# ------------------------------------------------------------

# ------------------------------------------------------------
# ğŸ“ WORKSPACE & DIRECTORY SETUP
# ------------------------------------------------------------
# ğŸ“ WORKDIR â€” Container Internal Workspace
# All subsequent commands will execute from this path inside the container.
# Helps maintain a clean, organized container filesystem.
WORKDIR /app

# ------------------------------------------------------------
# ğŸ§© SYSTEM DEPENDENCIES
# Installs only essential packages required for Rust compilation
# ------------------------------------------------------------

# ------------------------------------------------------------
# ğŸ§© SYSTEM DEPENDENCIES
# ------------------------------------------------------------
# ğŸ§© SYSTEM DEPENDENCIES â€” Required Packages for Compilation
# Installs only the minimum necessary to compile Rust code,
# including SSL libraries and build tools.
# Cleans up after install to reduce image size and avoid cache bloat.
RUN apt-get update && apt-get install -y --no-install-recommends \
    # Core build utilities: gcc, make, etc.
    build-essential \
    # Trust store for HTTPS requests
    ca-certificates \
    # SSL support (for crates like reqwest)
    libssl-dev \
    # Build helper for system libraries
    pkg-config \
 && apt-get clean \
 && rm -rf /var/lib/apt/lists/*

##############################################################
# â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
# â”‚ BLOCK: BODY (build and runtime container)  â”‚
# â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
##############################################################

##############################################################
# ğŸ“‚ BUILD STAGE â€” Compile OmniCode Binary (Stage 1)
##############################################################

# This stage prepares a clean build environment, installs all required
# dependencies, and compiles the OmniCode system binary using Cargo.
# It does not contain any runtime logicâ€”only compilation and validation.

# ------------------------------------------------------------
# ğŸ“¦ Copy Source â€” Move OmniCode codebase into container
# ------------------------------------------------------------
# Transfer full source tree from host to /app/code
COPY code/ /app/code

# ------------------------------------------------------------
# ğŸ” Pre-Build Debug â€” Inspect source structure
# ------------------------------------------------------------
# Optional debug: lists files prior to build
RUN echo "ğŸ“¦ Pre-Build: /app/code/" && ls -la /app/code

# ------------------------------------------------------------
# ğŸ§± Compile â€” Build release binary using Cargo
# ------------------------------------------------------------
# Builds system binary in release mode using specified manifest path
RUN cargo build --release --manifest-path code/Cargo.toml

# ------------------------------------------------------------
# ğŸ§¾ Post-Build Debug â€” Confirm compiled artifacts
# ------------------------------------------------------------
# Optional debug: lists compiled output for verification
RUN echo "ğŸ§± Build complete: /app/code/target/release" && ls -R /app/code/target/release


##############################################################
# ğŸ“‚ RUNTIME STAGE â€” Prepare Container for Execution (Stage 2)
##############################################################

# This stage creates the runtime environment for the built OmniCode binary.
# It sets up the logs directory, enforces safer execution with a non-root user,
# and brings in the compiled binary without bloating the final image with build tools.

# ------------------------------------------------------------
# ğŸ  Set Runtime Environment â€” Working directory
# ------------------------------------------------------------
# Uses a slim Rust base (no compiler) to minimize image size
FROM rust:1.87.0-slim

# Sets working directory inside container
WORKDIR /app

# ------------------------------------------------------------
# ğŸ—‚ Logs & User Setup â€” Safer execution context
# ------------------------------------------------------------
# Creates logs folder for runtime use
# Adds non-root system user for secure process execution
# Assigns ownership of logs directory to appuser
RUN mkdir -p /app/logs \
 && useradd -m appuser \
 && chown -R appuser:appuser /app/logs

# ------------------------------------------------------------
# ğŸ“¥ Transfer Binary â€” Move built release binary to runtime
# ------------------------------------------------------------
# Copies compiled binary from builder container into runtime image
COPY --from=builder /app/code/target/release/omnicode .

# ------------------------------------------------------------
# ğŸ” Permissions â€” Ensure binary is executable
# ------------------------------------------------------------
# Grants execute permissions on binary file
RUN chmod +x ./omnicode

##############################################################
# â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
# â”‚ BLOCK: CLOSING â€” Seal, Integrity & Covenantâ”‚
# â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
##############################################################

# ------------------------------------------------------------
# ğŸ”’ Privilege Drop â€” Enforce non-root execution
# ------------------------------------------------------------
# Switch to unprivileged user (defined in prior setup)
USER appuser

# ------------------------------------------------------------
# ğŸš€ Launch OmniCode â€” Set container entrypoint
# ------------------------------------------------------------
# Defines the command executed when container starts
CMD ["./omnicode"]

# ------------------------------------------------------------
# ğŸ”š LOGIC TERMINUS â€” End of Executable Flow
# All runtime targets end above this line. Below is annotation only.
# ------------------------------------------------------------

## ğŸ”š Scroll Closure Summary:
##   This Dockerfile anchors Phase 0 of OmniCodeâ€™s build system.
##   It ensures the Rust binary is compiled cleanly, securely run,
##   and future-proofed for CI/CD and orchestration integrations.

## ğŸš¨ Covenant Warning:
##   Do not alter build stages without Watchtower log and test.
##   The split-stage design protects system integrity and traceability.

## ğŸ“… Scroll Metadata:
##   _version_:        0.0.1
##   _last updated_:   2025-06-16
##   _author_:         Seanje Lenox-Wise / Nova Dawn
##   _status_:         Active
##   _component_:      Docker Build & Runtime
##   _project_:        OmniCore / OmniCode

## ğŸ§¾ Scroll Seal:
##   This scroll is covenantalâ€”preserve structure and order.
##   All scrolls begin and end with alignment. Guard this.
